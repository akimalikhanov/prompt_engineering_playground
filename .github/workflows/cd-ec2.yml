name: CD (Deploy to EC2 via SSM)

on:
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: "Git SHA (or tag) to deploy. Used for BOTH repo checkout and IMAGE_TAG. Defaults to workflow SHA."
        required: false
        type: string

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      EC2_INSTANCE_ID: ${{ vars.EC2_INSTANCE_ID }}

      INSTALL_ROOT: /opt/pep
      REPO_DIR: /opt/pep/prompt_engineering_playground
      REPO_URL: https://github.com/${{ github.repository }}.git
      SSM_BASE_PATH: ${{ vars.SSM_BASE_PATH }}

      # Single deploy version:
      DEPLOY_REF: ${{ inputs.deploy_ref || github.sha }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_CD_ROLE_TO_ASSUME }}

      - name: Validate required variables
        shell: bash
        run: |
          set -euo pipefail
          : "${AWS_REGION:?Missing variable AWS_REGION}"
          : "${EC2_INSTANCE_ID:?Missing variable EC2_INSTANCE_ID}"
          : "${SSM_BASE_PATH:?Missing variable SSM_BASE_PATH}"
          : "${DEPLOY_REF:?Missing DEPLOY_REF}"

      - name: Deploy via SSM (send + wait + print logs)
        shell: bash
        timeout-minutes: 15
        run: |
          set -euo pipefail

          echo "Deploying DEPLOY_REF=$DEPLOY_REF to instance=$EC2_INSTANCE_ID region=$AWS_REGION"

          REMOTE_SCRIPT="$(cat <<EOF
          #!/usr/bin/env bash
          set -euo pipefail

          INSTALL_ROOT="${INSTALL_ROOT}"
          REPO_DIR="${REPO_DIR}"
          REPO_URL="${REPO_URL}"
          AWS_REGION="${AWS_REGION}"
          SSM_BASE_PATH="${SSM_BASE_PATH}"
          DEPLOY_REF="${DEPLOY_REF}"

          echo "[remote] install_root=\$INSTALL_ROOT"
          echo "[remote] repo_dir=\$REPO_DIR"
          echo "[remote] deploy_ref=\$DEPLOY_REF"

          command -v git >/dev/null
          command -v docker >/dev/null
          command -v aws >/dev/null

          mkdir -p "\$INSTALL_ROOT"

          # Safety guard for rm -rf
          if [[ -z "\$REPO_DIR" || "\$REPO_DIR" == "/" || "\$REPO_DIR" == "/opt" || "\$REPO_DIR" == "/opt/pep" ]]; then
            echo "Refusing to rm -rf unsafe REPO_DIR='\$REPO_DIR'" >&2
            exit 2
          fi

          rm -rf "\$REPO_DIR"
          mkdir -p "\$REPO_DIR"
          cd "\$REPO_DIR"

          # Fetch EXACT ref (SHA or tag). Keep it simple + reliable.
          git init -q
          git remote add origin "\$REPO_URL"
          git fetch -q --tags origin "\$DEPLOY_REF"
          git checkout -q --detach FETCH_HEAD

          # Use the SAME ref for image tag + commit verification
          INSTALL_ROOT="\$INSTALL_ROOT" \
          REPO_DIR="\$REPO_DIR" \
          AWS_REGION="\$AWS_REGION" \
          SSM_BASE_PATH="\$SSM_BASE_PATH" \
          DEPLOY_REF="\$DEPLOY_REF" \
            bash ./infra/deploy/ec2_deploy.sh \
              --deploy-ref "\$DEPLOY_REF" \
              --install-root "\$INSTALL_ROOT" \
              --repo-dir "\$REPO_DIR" \
              --region "\$AWS_REGION" \
              --ssm-path "\$SSM_BASE_PATH"
          EOF
          )"

          REMOTE_B64="$(printf '%s' "$REMOTE_SCRIPT" | base64 -w0)"
          RUN_CMD="echo '$REMOTE_B64' | base64 -d > /tmp/pep_deploy.sh && chmod +x /tmp/pep_deploy.sh && /tmp/pep_deploy.sh"

          PARAMS="$(jq -n --arg cmd "$RUN_CMD" '{commands: [$cmd]}')"

          COMMAND_ID="$(
            aws ssm send-command \
              --region "$AWS_REGION" \
              --instance-ids "$EC2_INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy pep: ${DEPLOY_REF:0:12}" \
              --parameters "$PARAMS" \
              --query "Command.CommandId" \
              --output text
          )"

          echo "SSM command_id=$COMMAND_ID"

          echo "Waiting for SSM command to complete..."

          for i in {1..90}; do
            STATUS="$(aws ssm get-command-invocation \
              --region "$AWS_REGION" \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")"

            if [[ "$STATUS" != "InProgress" && "$STATUS" != "Pending" ]]; then
              break
            fi

            echo "  [$i/90] Status: $STATUS"
            sleep 10
          done

          OUT="$(aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$EC2_INSTANCE_ID" \
            --output json)"

          STATUS="$(echo "$OUT" | jq -r '.Status')"
          echo "SSM status: $STATUS"
          echo "---- STDOUT ----"
          echo "$OUT" | jq -r '.StandardOutputContent'
          echo "---- STDERR ----"
          echo "$OUT" | jq -r '.StandardErrorContent'

          [[ "$STATUS" == "Success" ]]
