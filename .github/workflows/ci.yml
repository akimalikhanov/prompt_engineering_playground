name: CI (Tests + Container push to ECR)

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------
  # Python: lint + format + typecheck
  # --------------------
  python-quality:
    name: Python Quality (Lint, Format, Types)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv
        with:
          groups: dev api ui providers-api

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

      - name: Pyright
        run: uv run pyright --level error

  # --------------------
  # Unit tests
  # --------------------
  test:
    name: Pytest (Unit Tests)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv
        with:
          groups: dev api ui providers-api

      - name: Run tests
        run: uv run pytest -q

  # --------------------
  # Dependency vulnerability scanning
  # --------------------
  deps-audit:
    name: Pip Audit (Dependencies)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv

      - name: Install pip-audit
        run: uv tool install pip-audit

      - name: Audit API dependencies
        run: |
          uv export --format requirements-txt --no-dev \
            --group api --group providers-api \
            | pip-audit -r /dev/stdin

      - name: Audit UI dependencies
        run: |
          uv export --format requirements-txt --no-dev \
            --group ui --group providers-api \
            | pip-audit -r /dev/stdin

  # --------------------
  # SAST (Semgrep)
  # --------------------
  sast:
    name: Semgrep (SAST)
    runs-on: ubuntu-22.04
    container:
      image: semgrep/semgrep:1.145.0
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Run Semgrep
        run: semgrep scan --config p/security-audit --error .

  # --------------------
  # Secret scanning
  # --------------------
  secrets:
    name: Gitleaks (Secrets)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --------------------
  # Container scanning (Dockerfile lint + config)
  # --------------------
  container-scan:
    name: Container Scanning (Hadolint + Trivy)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          count=$(find . -name "Dockerfile*" -type f | wc -l)
          echo "count=${count}" >> $GITHUB_OUTPUT

      - name: Hadolint
        if: steps.find-dockerfiles.outputs.count != '0'
        run: |
          find . -name "Dockerfile*" -type f | while read -r dockerfile; do
            echo "::group::Hadolint: ${dockerfile}"
            docker run --rm -i hadolint/hadolint hadolint --failure-threshold error - < "${dockerfile}"
            echo "::endgroup::"
          done

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: config
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: 1

  # --------------------
  # Build & Push images to ECR (docker compose)
  # --------------------
  container-ecr-push:
    name: Build & Push images to ECR (docker compose)
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == 'dev')
    needs:
      - python-quality
      - test
      - deps-audit
      - sast
      - secrets
      - container-scan
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      ECR_REGISTRY: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com

      # Compose will interpolate these into `image: ...`
      ECR_REPO_API: ${{ vars.ECR_REPO_API }}
      ECR_REPO_UI: ${{ vars.ECR_REPO_UI }}
      ECR_REPO_MLFLOW: ${{ vars.ECR_REPO_MLFLOW }}
      IMAGE_TAG: ${{ github.sha }}

      # Optional: make builds faster/consistent
      DOCKER_BUILDKIT: "1"
      COMPOSE_DOCKER_CLI_BUILD: "1"

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # Enable modern Docker build (faster + future-proof)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@33f92af657bba1882ab79d8621debd2f6769a0c9

      - name: Build images (compose)
        run: docker compose -f infra/deploy/docker-compose-prod.yml build api ui mlflow

      - name: Push images (compose)
        run: docker compose -f infra/deploy/docker-compose-prod.yml push api ui mlflow

  # --------------------
  # All checks passed gate
  # --------------------
  ci-success:
    name: CI Success
    needs:
      - python-quality
      - test
      - deps-audit
      - sast
      - secrets
      - container-scan
      - container-ecr-push
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          # Always-required jobs must be successful.
          required_results=(
            "${{ needs.python-quality.result }}"
            "${{ needs.test.result }}"
            "${{ needs.deps-audit.result }}"
            "${{ needs.sast.result }}"
            "${{ needs.secrets.result }}"
            "${{ needs.container-scan.result }}"
          )
          for result in "${required_results[@]}"; do
            if [[ "$result" != "success" ]]; then
              echo "One or more required jobs failed"
              exit 1
            fi
          done

          # ECR push is expected to be skipped on PRs.
          ecr_result="${{ needs.container-ecr-push.result }}"
          if [[ "$ecr_result" != "success" && "$ecr_result" != "skipped" ]]; then
            echo "ECR push job failed"
            exit 1
          fi
          echo "All CI checks passed!"
