name: CI

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------
  # Python: lint + format + typecheck
  # --------------------
  python-quality:
    name: Python Quality (Lint, Format, Types)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv
        with:
          groups: dev api ui providers-api

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

      - name: Pyright
        run: uv run pyright --level error

  # --------------------
  # Unit tests
  # --------------------
  test:
    name: Pytest (Unit Tests)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv
        with:
          groups: dev api ui providers-api

      - name: Run tests
        run: uv run pytest -q

  # --------------------
  # Dependency vulnerability scanning
  # --------------------
  deps-audit:
    name: Pip Audit (Dependencies)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: ./.github/actions/setup-python-uv

      - name: Install pip-audit
        run: uv tool install pip-audit

      - name: Audit API dependencies
        run: |
          uv export --format requirements-txt --no-dev \
            --group api --group providers-api \
            | pip-audit -r /dev/stdin

      - name: Audit UI dependencies
        run: |
          uv export --format requirements-txt --no-dev \
            --group ui --group providers-api \
            | pip-audit -r /dev/stdin

  # --------------------
  # SAST (Semgrep)
  # --------------------
  sast:
    name: Semgrep (SAST)
    runs-on: ubuntu-22.04
    container:
      image: semgrep/semgrep:1.145.0
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Run Semgrep
        run: semgrep scan --config p/security-audit --error .

  # --------------------
  # Secret scanning
  # --------------------
  secrets:
    name: Gitleaks (Secrets)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --------------------
  # Container scanning (Dockerfile lint + config)
  # --------------------
  container-scan:
    name: Container Scanning (Hadolint + Trivy)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          count=$(find . -name "Dockerfile*" -type f | wc -l)
          echo "count=${count}" >> $GITHUB_OUTPUT

      - name: Hadolint
        if: steps.find-dockerfiles.outputs.count != '0'
        run: |
          find . -name "Dockerfile*" -type f | while read -r dockerfile; do
            echo "::group::Hadolint: ${dockerfile}"
            docker run --rm -i hadolint/hadolint hadolint --failure-threshold error - < "${dockerfile}"
            echo "::endgroup::"
          done

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: config
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: 1

  # --------------------
  # Build Docker images
  # --------------------
  container-build:
    name: Build Docker images (api, ui, mlflow)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # Enable modern Docker build (faster + future-proof)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      # Build only the services that have "build:"
      - name: Build images with Docker Compose
        env:
          DOCKER_BUILDKIT: "1"
          COMPOSE_DOCKER_CLI_BUILD: "1"
        run: |
          docker compose \
            -f infra/docker-compose.yml \
            build api ui mlflow

  # --------------------
  # All checks passed gate
  # --------------------
  ci-success:
    name: CI Success
    needs:
      - python-quality
      - test
      - deps-audit
      - sast
      - secrets
      - container-scan
      - container-build
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          results=(
            "${{ needs.python-quality.result }}"
            "${{ needs.test.result }}"
            "${{ needs.deps-audit.result }}"
            "${{ needs.sast.result }}"
            "${{ needs.secrets.result }}"
            "${{ needs.container-scan.result }}"
            "${{ needs.container-build.result }}"
          )
          for result in "${results[@]}"; do
            if [[ "$result" != "success" ]]; then
              echo "One or more jobs failed"
              exit 1
            fi
          done
          echo "All CI checks passed!"
