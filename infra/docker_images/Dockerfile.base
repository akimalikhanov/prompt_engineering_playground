# ============================================
# Base stage: system deps + core Python deps
# ============================================
FROM python:3.12-slim AS base

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# System dependencies (adjust if you need more)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
 && rm -rf /var/lib/apt/lists/*

# Create non-root user (used at runtime in final stages)
ARG APP_UID=10001
ARG APP_GID=10001
RUN groupadd --gid "${APP_GID}" app \
 && useradd --uid "${APP_UID}" --gid "${APP_GID}" --create-home --shell /usr/sbin/nologin app
ENV HOME=/home/app \
    XDG_CACHE_HOME=/home/app/.cache

# Install uv
RUN pip install --no-cache-dir uv==0.8.19

# Copy project metadata
COPY pyproject.toml ./pyproject.toml
COPY uv.lock ./uv.lock

# Install ONLY base deps from [project].dependencies
# - no dev group
# - no other dependency-groups (api/ui/providers-*)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev --no-default-groups --frozen

# Make sure we use the project venv
# So python, uv, pip etc. now refer to the project venv, not system Python.
ENV PATH="/app/.venv/bin:${PATH}"

# Copy shared code (used by both API and UI)
COPY utils/ ./utils/
COPY config/ ./config/
COPY schemas/ ./schemas/
COPY services/ ./services/

# Allow top-level imports like "import utils"
ENV PYTHONPATH=/app


# ============================================
# API stage: Backend service
# ============================================
FROM base AS api

WORKDIR /app

# Install API-specific groups on top of base:
# - api            : FastAPI, gunicorn, SQLAlchemy, etc.
# - providers-api  : openai, google-genai
# (NO dev, NO ui, NO providers-local here by default)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev --no-default-groups --frozen \
    --group api \
    --group providers-api
    # If this container should also run local vLLM, add:
    # --group providers-local

# Copy backend-specific code
COPY api/ ./api/
COPY adapters/ ./adapters/
COPY models/ ./models/

# Drop privileges for runtime
RUN mkdir -p "${HOME}" "${XDG_CACHE_HOME}" \
 && chown -R app:app /app "${HOME}"
USER app

EXPOSE 8000

# Run with gunicorn (adjust module path if needed)
CMD ["gunicorn", "-c", "services/gunicorn.conf.py"]


# ============================================
# UI stage: Frontend/Gradio service
# ============================================
FROM base AS ui

WORKDIR /app

# Install UI-specific groups on top of base:
# - ui            : gradio, httpx
# - providers-api : openai, google-genai (for calling API LLMs)
# (NO dev, NO api, NO providers-local)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev --no-default-groups --frozen \
    --group ui \
    --group providers-api

# Copy frontend-specific code
COPY ui/ ./ui/

# Drop privileges for runtime
RUN mkdir -p "${HOME}" "${XDG_CACHE_HOME}" \
 && chown -R app:app /app "${HOME}"
USER app

EXPOSE 7860

# Let UI talk to API via Docker service name (in docker-compose)
ENV BACKEND_URL=http://api:8000

# Run Gradio app
CMD ["python", "-m", "ui.app"]
